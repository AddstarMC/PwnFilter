<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PwnFilterBukkitPlugin.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PwnFilter</a> &gt; <a href="index.source.html" class="el_package">com.pwn9.filter.bukkit</a> &gt; <span class="el_source">PwnFilterBukkitPlugin.java</span></div><h1>PwnFilterBukkitPlugin.java</h1><pre class="source lang-java linenums">/*
 *  PwnFilter - Chat and user-input filter with the power of Regex
 *  Copyright (C) 2016 Pwn9.com / Sage905 &lt;sage905@takeflight.ca&gt;
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 *
 *
 */

package com.pwn9.filter.bukkit;

import com.google.common.collect.MapMaker;
import com.pwn9.filter.bukkit.config.BukkitConfig;
import com.pwn9.filter.bukkit.listener.*;
import com.pwn9.filter.engine.FilterService;
import com.pwn9.filter.engine.api.FilterClient;
import com.pwn9.filter.engine.rules.action.minecraft.MinecraftAction;
import com.pwn9.filter.engine.rules.action.targeted.TargetedAction;
import com.pwn9.filter.minecraft.api.MinecraftConsole;
import com.pwn9.filter.minecraft.command.pfcls;
import com.pwn9.filter.minecraft.command.pfmute;
import com.pwn9.filter.minecraft.command.pfreload;
import com.pwn9.filter.util.tag.RegisterTags;
import net.milkbowl.vault.economy.Economy;
import org.bstats.bukkit.Metrics;
import org.bukkit.configuration.InvalidConfigurationException;
import org.bukkit.configuration.file.YamlConfiguration;
import org.bukkit.event.HandlerList;
import org.bukkit.plugin.RegisteredServiceProvider;
import org.bukkit.plugin.java.JavaPlugin;

import java.io.File;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentMap;


/**
 * A Regular Expression (REGEX) Chat Filter For Bukkit with many great features
 *
 * @author sage905
 * @version $Id: $Id
 */

public class PwnFilterBukkitPlugin extends JavaPlugin implements PwnFilterPlugin, TemplateProvider {
<span class="nc" id="L59">    public static final ConcurrentMap&lt;UUID, String&gt; lastMessage = new MapMaker().concurrencyLevel(2).weakKeys().makeMap();</span>
<span class="nc" id="L60">    static Economy economy = null;</span>
    private static PwnFilterBukkitPlugin _instance;
    private BukkitAPI minecraftAPI;
    private MinecraftConsole console;
    private FilterService filterService;
<span class="nc" id="L65">    private final Map&lt;String, Integer &gt; eventRules = new HashMap&lt;&gt;();</span>


    /**
     * &lt;p&gt;Constructor for PwnFilter.&lt;/p&gt;
     */
<span class="nc" id="L71">    public PwnFilterBukkitPlugin() {</span>

<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (_instance == null) {</span>
<span class="nc" id="L74">            _instance = this;</span>
        } else {
<span class="nc" id="L76">            throw new IllegalStateException(&quot;Only one instance of PwnFilter can be run per server&quot;);</span>
        }
<span class="nc" id="L78">        minecraftAPI = new BukkitAPI(this);</span>
<span class="nc" id="L79">        console = new MinecraftConsole(minecraftAPI);</span>
<span class="nc" id="L80">        filterService = new FilterService(getLogger());</span>
<span class="nc" id="L81">        filterService.getActionFactory().addActionTokens(MinecraftAction.class);</span>
<span class="nc" id="L82">        filterService.getActionFactory().addActionTokens(TargetedAction.class);</span>
<span class="nc" id="L83">        filterService.getConfig().setTemplateProvider(this);</span>
<span class="nc" id="L84">        RegisterTags.all();</span>
<span class="nc" id="L85">    }</span>

    /**
     * &lt;p&gt;getInstance.&lt;/p&gt;
     *
     * @return a {@link PwnFilterBukkitPlugin} object.
     */
    public static PwnFilterBukkitPlugin getInstance() {
<span class="nc" id="L93">        return _instance;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void onLoad() {

<span class="nc" id="L102">    }</span>

    /**
     * &lt;p&gt;onEnable.&lt;/p&gt;
     */
    public void onEnable() {
        // Initialize Configuration
<span class="nc" id="L109">        saveDefaultConfig();</span>

        // Set up a Vault economy for actions like &quot;fine&quot; (optional)
<span class="nc" id="L112">        setupEconomy();</span>

        // Now get our configuration
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (!configurePlugin()) return;</span>

<span class="nc" id="L117">        filterService.registerAuthorService(minecraftAPI);</span>
<span class="nc" id="L118">        filterService.registerNotifyTarget(minecraftAPI);</span>

        //Load up our listeners
        //        BaseListener.setAPI(minecraftAPI);

<span class="nc" id="L123">        filterService.registerClient(new PwnFilterCommandListener(this));</span>
<span class="nc" id="L124">        filterService.registerClient(new PwnFilterInvListener(this));</span>
<span class="nc" id="L125">        filterService.registerClient(new PwnFilterPlayerListener(this));</span>
<span class="nc" id="L126">        filterService.registerClient(new PwnFilterServerCommandListener(this));</span>
<span class="nc" id="L127">        filterService.registerClient(new PwnFilterSignListener(this));</span>
<span class="nc" id="L128">        filterService.registerClient(new PwnFilterBookListener(this));</span>


        // The Entity Death handler, for custom death messages.
<span class="nc" id="L132">        getServer().getPluginManager().registerEvents(new PwnFilterEntityListener(), this);</span>
        // The DataCache handler, for async-safe player info (name/world/permissions)
<span class="nc" id="L134">        getServer().getPluginManager().registerEvents(new PlayerCacheListener(), this);</span>

        // Enable the listeners
<span class="nc" id="L137">        filterService.enableClients();</span>

        // Set up Command Handlers
<span class="nc" id="L140">        getCommand(&quot;pfreload&quot;).setExecutor(new pfreload(filterService, this));</span>
<span class="nc" id="L141">        getCommand(&quot;pfcls&quot;).setExecutor(new pfcls(getLogger(), console));</span>
<span class="nc" id="L142">        getCommand(&quot;pfmute&quot;).setExecutor(new pfmute(getLogger(), console));</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        for (final FilterClient f : filterService.getActiveClients()) {</span>
<span class="nc" id="L144">            final String eventName = f.getShortName();</span>
<span class="nc" id="L145">            int value = f.getRuleChain().ruleCount();</span>
<span class="nc" id="L146">            eventRules.put(eventName,value);</span>
<span class="nc" id="L147">        }</span>
<span class="nc" id="L148">        Metrics metrics = new Metrics(this, 8480);</span>
<span class="nc" id="L149">        Metrics.AdvancedPie pie = new Metrics.AdvancedPie(&quot;Rules by Event&quot;, () -&gt; eventRules);</span>
<span class="nc" id="L150">        metrics.addCustomChart(pie);</span>
<span class="nc" id="L151">    }</span>

    /**
     * &lt;p&gt;onDisable.&lt;/p&gt;
     */
    public void onDisable() {
<span class="nc" id="L157">        HandlerList.unregisterAll(this); // Unregister all Bukkit Event handlers.</span>
<span class="nc" id="L158">        filterService.shutdown();</span>
<span class="nc" id="L159">        filterService.deregisterAuthorService(minecraftAPI);</span>
<span class="nc" id="L160">    }</span>

    public boolean configurePlugin() {
<span class="nc" id="L163">        minecraftAPI.reset();</span>
        try {
            // Stupid hack because YamlConfiguration.loadConfiguration() eats our exception
<span class="nc" id="L166">            YamlConfiguration config = new YamlConfiguration();</span>
<span class="nc" id="L167">            config.load(new File(getDataFolder(), &quot;config.yml&quot;));</span>

<span class="nc" id="L169">            reloadConfig();</span>
<span class="nc" id="L170">            BukkitConfig.loadConfiguration(getConfig(), getDataFolder(), filterService);</span>
<span class="nc" id="L171">            return true;</span>
<span class="nc" id="L172">        } catch (InvalidConfigurationException | IOException ex) {</span>
<span class="nc" id="L173">            filterService.getLogger().severe(&quot;Fatal configuration failure: &quot; + ex.getMessage());</span>
<span class="nc" id="L174">            filterService.getLogger().severe(&quot;PwnFilter disabled.&quot;);</span>
<span class="nc" id="L175">            getPluginLoader().disablePlugin(this);</span>
        }
<span class="nc" id="L177">        return false;</span>
    }

    private void setupEconomy() {

<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (getServer().getPluginManager().getPlugin(&quot;Vault&quot;) != null) {</span>
<span class="nc" id="L183">            RegisteredServiceProvider&lt;Economy&gt; rsp = getServer().getServicesManager().getRegistration(Economy.class);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">            if (rsp != null) {</span>
<span class="nc" id="L185">                economy = rsp.getProvider();</span>
<span class="nc" id="L186">                filterService.getLogger().info(&quot;Vault found. Enabling actions requiring Vault&quot;);</span>
<span class="nc" id="L187">                return;</span>
            }
        }
<span class="nc" id="L190">        filterService.getLogger().info(&quot;Vault dependency not found.  Disabling actions requiring Vault&quot;);</span>
<span class="nc" id="L191">    }</span>

    @Override
    public FilterService getFilterService() {
<span class="nc" id="L195">        return filterService;</span>
    }

    @Override
    public MinecraftConsole getConsole() {
<span class="nc" id="L200">        return console;</span>
    }

}


</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>