<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LimitedRegexCharSequence.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PwnFilter</a> &gt; <a href="index.source.html" class="el_package">com.pwn9.filter.util</a> &gt; <span class="el_source">LimitedRegexCharSequence.java</span></div><h1>LimitedRegexCharSequence.java</h1><pre class="source lang-java linenums">/*
 *  PwnFilter - Chat and user-input filter with the power of Regex
 *  Copyright (C) 2016 Pwn9.com / Sage905 &lt;sage905@takeflight.ca&gt;
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 *
 *
 */

package com.pwn9.filter.util;

import com.google.common.base.Stopwatch;
import com.google.common.base.Ticker;
import org.jetbrains.annotations.NotNull;

import java.util.concurrent.TimeUnit;

/**
 * Create a Timed Regex match.
 * User: Sage905
 * Date: 13-07-26
 * Time: 4:35 PM
 *
 * @author Sage905
 * @version $Id: $Id
 */

/* NOTE: The goal here is to create a matcher that won't run forever.
 Here's how this works:
 1. The TimeoutRegexCharSequence has a timeout set in it of the system time + some interval.
 2. On every charAt access, we check to see if we're past that time.
 3. If so, then throw an exception, which will halt the regex processing, and notify
 4. the caller.  In PwnFilter, we can then check for this exception, disable the rule, and log the offending regex and
 string.
*/
public class LimitedRegexCharSequence implements CharSequence {

    private final CharSequence inner;

    private final Ticker ticker;

    private final Stopwatch stopwatch;

    private final int timeoutMillis;

    private long accessCount;

    /**
     * &lt;p&gt;Constructor for LimitedRegexCharSequence.&lt;/p&gt;
     *
     * @param inner         a {@link java.lang.CharSequence} object.
     * @param timeoutMillis a int.
     */

    public LimitedRegexCharSequence(CharSequence inner, int timeoutMillis) {
<span class="fc" id="L67">        this(inner, timeoutMillis, Ticker.systemTicker());</span>
<span class="fc" id="L68">    }</span>

    LimitedRegexCharSequence(CharSequence inner, int timeoutMillis, Ticker ticker) {
<span class="fc" id="L71">        super();</span>
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">        if (inner == null) {</span>
<span class="nc" id="L73">            throw new NullPointerException(&quot;CharSequence must not be null&quot;);</span>
        }
<span class="fc" id="L75">        this.inner = inner;</span>

<span class="fc" id="L77">        this.ticker = ticker;</span>
<span class="fc" id="L78">        this.stopwatch = Stopwatch.createStarted(this.ticker);</span>

<span class="fc" id="L80">        this.timeoutMillis = timeoutMillis;</span>
<span class="fc" id="L81">        accessCount = 0;</span>
<span class="fc" id="L82">    }</span>

    /**
     * {@inheritDoc}
     */
    public char charAt(int index) {
<span class="fc" id="L88">        accessCount++;</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        if (stopwatch.elapsed(TimeUnit.MILLISECONDS) &gt; timeoutMillis) {</span>
<span class="fc" id="L90">            throw new RegexTimeoutException(&quot;Timeout occurred after &quot; + timeoutMillis + &quot;ms&quot;);</span>
        }
<span class="fc" id="L92">        return inner.charAt(index);</span>
    }

    /**
     * &lt;p&gt;length.&lt;/p&gt;
     *
     * @return a int.
     */
    public int length() {
<span class="fc" id="L101">        return inner.length();</span>
    }

    /**
     * {@inheritDoc}
     */
    public CharSequence subSequence(int start, int end) {
<span class="nc" id="L108">        return new LimitedRegexCharSequence(inner.subSequence(start, end), timeoutMillis, this.ticker);</span>
    }

    /**
     * &lt;p&gt;Getter for the field &lt;code&gt;accessCount&lt;/code&gt;.&lt;/p&gt;
     *
     * @return a long.
     */
    long getAccessCount() {
<span class="fc" id="L117">        return accessCount;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    @NotNull
    public String toString() {
<span class="nc" id="L126">        return inner.toString();</span>
    }

    public final class RegexTimeoutException extends RuntimeException {
<span class="fc" id="L130">        RegexTimeoutException(String message) {</span>
<span class="fc" id="L131">            super(message);</span>
<span class="fc" id="L132">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>